#!/usr/bin/env ruby
# frozen_string_literal: true

#
# scripts/goal-get - Read a single pipeline goal from GitHub Issues
#
# Usage: goal-get [--repo OWNER/REPO] <number>
#
# Output: JSON {"ok": true, "number": ..., "title": ..., "status": ..., ...}
# Exit code: 0 on success, 1 on failure
#

require 'json'
require 'optparse'

VALID_STATUSES = %w[draft queued running spot-check done stuck].freeze
STATUS_LABELS = VALID_STATUSES.map { |s| "goal:#{s}" }.freeze

def extract_status(labels)
  labels.each do |label|
    name = label.is_a?(Hash) ? label['name'] : label.to_s
    STATUS_LABELS.each do |sl|
      return sl.sub('goal:', '') if name == sl
    end
  end
  nil
end

def has_label?(labels, target)
  labels.any? do |label|
    name = label.is_a?(Hash) ? label['name'] : label.to_s
    name == target
  end
end

def parse_story_ref(body)
  return nil if body.nil?

  match = body.match(/Story:\s*#(\d+)/)
  match ? match[1].to_i : nil
end

def main
  nwo = nil

  OptionParser.new do |opts|
    opts.banner = <<~HELP
      Usage: goal-get [--repo OWNER/REPO] <number>

      Read a single pipeline goal from GitHub Issues.

      Arguments:
        --repo    Optional. GitHub repo in OWNER/REPO format.
        number    GitHub Issue number (required)

      Output:
        JSON with fields: number, title, status, spot_check, story, body

      Examples:
        goal-get 42
        goal-get 42 --repo mgreenly/ikigai
        goal-get 42 | jq .body
    HELP

    opts.on('--repo=REPO', 'GitHub repo (OWNER/REPO)') { |r| nwo = r }
  end.parse!

  number = ARGV[0]&.to_i

  unless number && number > 0
    puts JSON.generate(ok: false, items: ['issue number is required'])
    exit 1
  end

  cmd = ['gh', 'issue', 'view', number.to_s]
  cmd += ['--repo', nwo] if nwo
  cmd += ['--json', 'number,title,labels,body,state']

  stdout = IO.popen(cmd, err: '/dev/null', &:read)

  if $?.exitstatus != 0
    puts JSON.generate(ok: false, items: ["issue ##{number} not found"])
    exit 1
  end

  issue = JSON.parse(stdout) rescue nil

  unless issue
    puts JSON.generate(ok: false, items: ['could not parse gh output'])
    exit 1
  end

  labels = issue['labels'] || []

  unless has_label?(labels, 'goal')
    puts JSON.generate(ok: false, items: ["##{number} is not a goal"])
    exit 1
  end

  label_names = labels.map { |label| label.is_a?(Hash) ? label['name'] : label.to_s }

  puts JSON.generate(
    ok: true,
    number: issue['number'],
    title: issue['title'],
    status: extract_status(labels),
    spot_check: has_label?(labels, 'spot-check'),
    story: parse_story_ref(issue['body']),
    body: issue['body'],
    labels: label_names
  )
  exit 0
end

if __FILE__ == $PROGRAM_NAME
  begin
    main
  rescue Interrupt
    exit 130
  end
end
