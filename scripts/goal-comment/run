#!/usr/bin/env ruby
# frozen_string_literal: true

#
# scripts/goal-comment - Append a comment to a goal's GitHub issue
#
# Usage: echo "comment text" | goal-comment [--repo OWNER/REPO] <number>
#
# Output: JSON {"ok": true, "number": <number>}
# Exit code: 0 on success, 1 on failure
#

require 'json'
require 'optparse'

def main
  nwo = nil

  OptionParser.new do |opts|
    opts.banner = <<~HELP
      Usage: echo "comment text" | goal-comment [--repo OWNER/REPO] <number>

      Append a comment to a goal's GitHub issue.

      Arguments:
        --repo    Optional. GitHub repo in OWNER/REPO format.
        number    GitHub Issue number (required)

      Input:
        Comment body is read from stdin.

      What it does:
        Validates the goal exists, then adds a comment to the issue.

      Output:
        JSON {"ok": true, "number": <number>}

      Examples:
        echo "Analysis complete" | goal-comment 42
        echo "Analysis complete" | goal-comment 42 --repo mgreenly/ikigai
        cat report.md | goal-comment 42
    HELP

    opts.on('--repo=REPO', 'GitHub repo (OWNER/REPO)') { |r| nwo = r }
  end.parse!

  number = ARGV[0]&.to_i

  unless number && number > 0
    puts JSON.generate(ok: false, items: ['issue number is required'])
    exit 1
  end

  # Read comment body from stdin
  body = $stdin.read.strip

  if body.empty?
    puts JSON.generate(ok: false, items: ['comment body cannot be empty'])
    exit 1
  end

  # Validate this is a real goal
  goal_get = File.join(File.dirname(File.realpath(__FILE__)), '..', 'goal-get', 'run')
  goal_cmd = [goal_get, number.to_s]
  goal_cmd += ['--repo', nwo] if nwo
  goal_json = IO.popen(goal_cmd, err: '/dev/null', &:read)
  goal = (JSON.parse(goal_json) rescue nil)

  unless goal && goal['ok']
    puts JSON.generate(ok: false, items: ["##{number} is not a goal"])
    exit 1
  end

  # Add comment to the issue
  cmd = ['gh', 'issue', 'comment', number.to_s, '--body', body]
  cmd += ['--repo', nwo] if nwo
  ok = system(*cmd, out: '/dev/null', err: '/dev/null')

  unless ok
    puts JSON.generate(ok: false, items: ["failed to add comment to ##{number}"])
    exit 1
  end

  puts JSON.generate(ok: true, number: number)
  exit 0
end

if __FILE__ == $PROGRAM_NAME
  begin
    main
  rescue Interrupt
    exit 130
  end
end
